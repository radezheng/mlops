parameters:
- name: serviceconnectionname
  default: ''

steps:
- checkout: self

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{ parameters.serviceconnectionname }}
    scriptType: bash
    scriptLocation: inlineScript
    workingDirectory: $(Build.SourcesDirectory)
    inlineScript: |
      set -x
      pwd
      cd src
      ls
      az extension add -n ml --allow-preview false -y
      az ml -h
      # Check the status of the compute instance
      STATUS=$(az ml compute show --name "admin5" --resource-group rg-aml --workspace-name aml-ea --query "state" -o tsv)
      
      # If the compute instance is stopped, start it
      if [ "$STATUS" == "Stopped" ]; then
        echo "Compute instance is stopped. Starting it..."
        az ml compute start --name "admin5" --resource-group rg-aml --workspace-name aml-ea
      else
        echo "Compute instance is in state: $STATUS"
      fi
      az ml job create --file basic_job.yml --resource-group rg-aml --workspace-name aml-ea
  displayName: 'Run Azure Machine Learning Pipeline'